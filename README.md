# CryptoSlon - SAST-анализ - задача №3
Привет, эта инструкция по установке и запуску агента для решения задачи №3 
из хакатона. 

Базово агент настроен на использование gigachat-max и работает стабильно. 
Аген тестировался на OpenAI GPT-5-mini и GPT-5, где так же показал стабильную работу.

## Установка и настройка

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения
Скопируйте `.env.example` в `.env` и добавьте API ключи:
```bash
cp .env.example .env
```

Заполните файл `.env`:
```
GIGACHAT_CREDENTIALS=ваш_ключ_gigachat - необходимо
OPENAI_API_KEY=ваш_ключ_openai - опционально
```
### 3. Установка semgrep
Для запуска пайплайна нужно установить semgrep:
```bash
pip install semgrep
```
semgrep требует регистрации и активации, подробности: https://semgrep.dev/docs/getting-started/quickstart

после установки выполнить команду
```bash
semgrep login
```
и проследовать инструкциям.

После этого semgrep внутри приложения должен работать.

## Запуск
Агент может быть запущен в двух режимах - интерактивном (в режиме чата) и автоматическом.

Агент умеет делать следующие вещи: 
- Проводить базовый SAST-анализ кода
- Проводить triage-анализ отчета, полученного в ходе базового SAST-анализа
- Генерировать фиксы уязвимостей на основе triage-анализа
- Делать инъекции фиксов в код
- Проводить весь пайплайн за раз

Система получилась довольно хрупкой, поэтому с интерактивным режимом лучше не баловаться.

Вызов автоматического агента
```bash
python main.py sast automated -c "run full pipeline for /absolute/path/to/code_folder"
```
-c "run full pipeline for /path/to/code" - команда, которая передается в Агента, как инструкция к действию. 
Эта команда обрабатывается LLM, так что можно не придерживаться строгого формата, лишь бы смысл сохранялся.

Запуск агента в интерактивном режиме
```bash
python main.py sast interactive
```
Примеры команд, с которыми интерактивный агент хорошо справляется: 
- Сделай базовый SAST анализ моего кода /absolute/path/to/code/folder
- Сделай триаж анализ этого отчета /absolute/path/to/aggregated/report
- Запусти полный пайплайн на мой код /absolute/path/to/code/folder

Самое стабильное решение - запустить автоматического агента с полным пайплайном на существующий каталог.

В результате выполнения пайплайна будет создан каталог sast_reports с подробными отчетами о каждом проделанном шаге
и файл sast_report.txt, где будет обобщенный итог о выполненной задаче от LLM.

## Архитектура

### Модули SAST-анализа
Система SAST-анализа состоит из нескольких модулей:

**1. Сканеры безопасности**
- `semgrep_runner.py` - интеграция с Semgrep для поиска уязвимостей по паттернам
- `bandit_runner.py` - интеграция с Bandit для анализа Python-кода на уязвимости

**2. Обработка отчетов**
- `report_merger.py` - объединение отчетов от разных сканеров (Semgrep и Bandit) в единый формат
- `report_aggregator.py` - агрегация всех отчетов в JSON с категоризацией по CWE
- `rule_mappings.json` - маппинг правил сканеров на стандартные CWE-идентификаторы

**3. Анализ и исправление**
- `triage_analyzer.py` - триаж найденных уязвимостей, определение критичности и приоритетности
- `fix_generator.py` - генерация исправлений для уязвимостей с помощью LLM
- `code_injector.py` - автоматическая инъекция фиксов в код

### Агенты
Система использует интеллектуальных агентов для координации и выполнения задач:

**BaseAgent** (`agents/base_agent.py`)
- Базовый класс для всех агентов
- Поддержка памяти, инструментов и RAG (Retrieval-Augmented Generation)
- Интеграция с различными LLM-провайдерами (GigaChat, OpenAI, Google, Groq)

**SASTAgent** (`agents/sast_agent.py`)
- Специализированный агент для проведения SAST-анализа
- Управляет всем пайплайном безопасности
- Координирует работу инструментов сканирования, анализа и исправления

### Инструменты агентов
Агенты используют набор специализированных инструментов (`agents/tools/`):

**SAST-инструменты** (`sast_tools.py`)
- `SASTBasicTool` - проведение базового SAST-анализа
- `SASTTriageTool` - триаж и приоритизация уязвимостей
- `SASTFixTool` - генерация исправлений
- `SASTInjectTool` - применение фиксов в код
- `SASTPipelineTool` - запуск полного пайплайна

Каждый инструмент наследуется от `BaseTool` и предоставляет стандартизированный интерфейс для агентов.

## Пример полного пайплайна
1. Скачать каталог с кодом с сервера
```bash
scp -r admin@10.62.20.10:/home/admin/taskstate_orig /Users/izelikson/Downloads/taskstate_copy
```

2. Запустить агента в автоматическом режиме с полным пайплайном на этот каталог
```bash
python main.py sast automated -c "run full pipeline for /Users/izelikson/Downloads/taskstate_copy"
```
3. Ознакомиться с результатами
- отчеты каждого этапа лежат в папке sast_reports в каталоге с main.py
- отчет о работе агента лежит в файле sast_report.txt в каталоге с main.py
- фиксы кода можно найти по декораторам #LLM FIX внутри кода
- для всех файлов, в которые агент вносил изменения, созданы бэкапы, папка с бэкапами лежит рядом с каталогом кода

4. (Опционально) загрузить каталог с фиксами обратно на сервер
```bash
rsync -avz \                                                                             
/Users/izelikson/Downloads/taskstate_copy/ \
admin@10.62.20.10:/home/admin/taskstate-fix/
```