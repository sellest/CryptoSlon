# Vulnerability Report with Code Snippets

Total vulnerabilities: 10

## HIGH Severity (8 issues)

### 1. Неправильное управление привилегиями в маршрутах

**File:** `/taskstate/tsapp/routes.py`
**Location:** Lines 416-429
**CWE:** CWE-269 Improper Privilege Management
**Risk:** HIGH – множество (21) мест без корректных проверок доступа позволяет горизонтальную/вертикальную эскалацию привилегий.

**Vulnerable Code:**
```python
 413         reg = 0
 414         rid = f_rid_get(request)
 415         page = request.args.get(get_page_parameter(), type=int, default=1)
 416 >>>     if rid == 2:
 417 >>>         users = TS_User.query.order_by(TS_User.id.desc()).paginate(page=page, per_page=10)
 418 >>>         pagination = Pagination(page=page, total=users.total, record_name='users')
 419 >>>         app.logger.info('[FUNC] [/adminpanel] [Succeess] User:<%s> Role:<%d>/<%d> Read users: <%d>', current_user.login, current_user.rid, rid, len(users.items))
 420 >>>         return render_template("admpanel.html", users=users, rteam=rteam, reg=reg, pagination=pagination)
 421 >>>     else:
 422 >>>         users = TS_User.query.filter(TS_User.rid==2).order_by(TS_User.id.desc()).all()
 423 >>>         if len(users) == 0:
 424 >>>             reg = 1
 425 >>>             app.logger.info('[FUNC] [/adminpanel] [Succeess] User:<%s> Role:<%d>/<%d> Start initialization >> Registration of a new captain for the service', current_user.login, current_user.rid, rid)
 426 >>>             return render_template("admpanel.html", users=users, rteam=rteam, reg=reg)
 427 >>>         else:
 428 >>>             app.logger.warning('[FUNC] [/adminpanel] [Failed] User:<%s> Access is denied', current_user.login)
 429 >>>             return redirect(url_for('index'))
 430     
 431     
 432     @app.route('/adm/<int:id>/nrteam')
```

**Suggested Fix:** Явно внедрить декораторы @login_required/@roles_required и централизованные проверки ACL перед любыми чувствительными действиями; добавить unit/integ‑тесты на отказ без привилегий.

**Proof of Concept:** Обратиться к одному из эндпоинтов с админ‑функцией без токена/сессии (см. routes.py:416-451) и получить 200/успешный результат; либо вручную изменить роль/идентификатор в запросе/сессии и вызвать операции изменения ролей (routes.py:458-473).

---

### 2. Неправильное управление привилегиями в маршрутах

**File:** `/taskstate/tsapp/routes.py`
**Location:** Lines 436-451
**CWE:** CWE-269 Improper Privilege Management
**Risk:** HIGH – множество (21) мест без корректных проверок доступа позволяет горизонтальную/вертикальную эскалацию привилегий.

**Vulnerable Code:**
```python
 433     @login_required
 434     def adm_nrteam(id):
 435         rid = f_rid_get(request)
 436 >>>     if rid == 2:
 437 >>>         user = TS_User.query.filter(TS_User.id==id).order_by(TS_User.date.desc()).first()
 438 >>>         if user:
 439 >>>             if user.rid != 2:
 440 >>>                 user.rid += 1
 441 >>>                 try:
 442 >>>                     db.session.commit()
 443 >>>                     app.logger.info('[FUNC] [/adminpanel/nrteam] [Succeess] User:<%s> Role:<%d>/<%d> For user:<%s> upd role to:<%d>', current_user.login, current_user.rid, rid, user.login, user.rid)
 444 >>>                 except:
 445 >>>                     app.logger.error('[FUNC] [/adminpanel/nrteam] [Succeess] User:<%s> Role:<%d> For user:<%s> upd role to:<%d>. Error DB delete!', current_user.login, current_user.rid, user.login, user.rid)
 446 >>>                     return "Error DB delete!"
 447 >>>         else:
 448 >>>             app.logger.warning('[FUNC] [/adminpanel/nrteam] [Failed] User:<%s> Role:<%d> For user:<%s> upd role to:<%d> User not found!', current_user.login, current_user.rid, user.login, user.rid)
 449 >>>         return redirect(url_for('adm'))
 450 >>>     else:
 451 >>>         redirect(url_for('index'))
 452     
 453     
 454     @app.route('/adm/<int:id>/brteam')
```

**Suggested Fix:** Явно внедрить декораторы @login_required/@roles_required и централизованные проверки ACL перед любыми чувствительными действиями; добавить unit/integ‑тесты на отказ без привилегий.

**Proof of Concept:** Обратиться к одному из эндпоинтов с админ‑функцией без токена/сессии (см. routes.py:416-451) и получить 200/успешный результат; либо вручную изменить роль/идентификатор в запросе/сессии и вызвать операции изменения ролей (routes.py:458-473).

---

### 3. Неправильное управление привилегиями в маршрутах

**File:** `/taskstate/app.py`
**Location:** Lines 14-17
**CWE:** CWE-269 Improper Privilege Management
**Risk:** HIGH – множество (21) мест без корректных проверок доступа позволяет горизонтальную/вертикальную эскалацию привилегий.

**Vulnerable Code:**
```python
  11             app.logger.info('[INIT] [DB] [Succeess] DB create <%s>', app.config['SQLALCHEMY_DATABASE_URI'])
  12             time.sleep(3)
  13     
  14 >>> if __name__ == '__main__':
  15 >>>     with app.app_context():
  16 >>>         db.create_all()
  17 >>>         app.run()
```

**Suggested Fix:** Явно внедрить декораторы @login_required/@roles_required и централизованные проверки ACL перед любыми чувствительными действиями; добавить unit/integ‑тесты на отказ без привилегий.

**Proof of Concept:** Обратиться к одному из эндпоинтов с админ‑функцией без токена/сессии (см. routes.py:416-451) и получить 200/успешный результат; либо вручную изменить роль/идентификатор в запросе/сессии и вызвать операции изменения ролей (routes.py:458-473).

---

### 4. Code Injection через eval/exec

**File:** `/taskstate/tsapp/routes.py`
**Location:** Lines 217-218
**CWE:** CWE-95 Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')
**Risk:** HIGH – выполнение произвольного кода через eval/exec ведёт к RCE и полному захвату сервера.

**Vulnerable Code:**
```python
 214     @login_required
 215     def taskcreate():
 216         if request.method == "POST":
 217 >>>         if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):
 218 >>>             task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=eval(request.form['private']), uid1=current_user.id, uid2=-1)
 219                 try:
 220                     db.session.add(task)
 221                     db.session.commit()
```

**Suggested Fix:** Убрать eval/exec; заменить на безопасные парсеры/вайтлисты, использовать явное сопоставление операций и типов данных.

**Proof of Concept:** Передать в параметр, который попадает в eval/exec, значение: __import__('os').system('id') и получить выполнение команды (см. routes.py:217,218,258,262).

---

### 5. Code Injection через eval/exec

**File:** `/taskstate/tsapp/routes.py`
**Location:** Lines 258-262
**CWE:** CWE-95 Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')
**Risk:** HIGH – выполнение произвольного кода через eval/exec ведёт к RCE и полному захвату сервера.

**Vulnerable Code:**
```python
 255         task = TS_Task.query.filter(and_(TS_Task.uid1==current_user.id, TS_Task.tid==tid)).order_by(TS_Task.date.desc()).first()
 256         if task:
 257             if request.method == "POST":
 258 >>>             if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):
 259 >>>                 task.title = request.form['title']
 260 >>>                 task.description = request.form['description']
 261 >>>                 task.did = int(request.form['did'])
 262 >>>                 task.private = eval(request.form['private'])
 263                     try:
 264                         db.session.commit()
 265                         app.logger.info('[FUNC] [/task/edit] [Succeess] User:<%s> Edit task: <%s> owner:<%s>', current_user.login, task.tid, task.TS_User.login)
```

**Suggested Fix:** Убрать eval/exec; заменить на безопасные парсеры/вайтлисты, использовать явное сопоставление операций и типов данных.

**Proof of Concept:** Передать в параметр, который попадает в eval/exec, значение: __import__('os').system('id') и получить выполнение команды (см. routes.py:217,218,258,262).

---

### 6. Слабый механизм восстановления пароля

**File:** `/taskstate/tsapp/routes.py`
**Location:** Lines 120-196
**CWE:** CWE-640 Weak Password Recovery Mechanism for Forgotten Password
**Risk:** HIGH – позволяет перехватить/сбросить пароль жертвы через предсказуемый/несекурный токен или без достаточной верификации.

**Vulnerable Code:**
```python
 117             return render_template("reg.html")
 118     
 119     
 120 >>> @app.route('/passrec', methods=['POST','GET'])
 121 >>> def passrec():
 122 >>>     p = 0
 123 >>>     token = ""
 124 >>>     if len(request.args) > 0:
 125 >>>         if request.args.get('login'):
 126 >>>             ulogin = request.args.get('login')
 127 >>>             user = TS_User.query.filter(TS_User.login==ulogin).first()
 128 >>>             if user:
 129 >>>                 token = jwt_encod(user)
 130 >>>                 user.token = token
 131 >>>                 try:
 132 >>>                     db.session.add(user)
 133 >>>                     db.session.commit()
 134 >>>                     flash('Token created...')
 135 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> token <%s> created', ulogin, token)
 136 >>>                 except:
 137 >>>                     app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', ulogin)
 138 >>>                     flash('Error DB insert')
 139 >>>             else:
 140 >>>                 flash('Login incorrect')
 141 >>>                 app.logger.warning('[AUTH] [passrec] [Failed] User:<%s> does not exist', ulogin)
 142 >>>         if request.args.get('token') and not request.args.get('password'):
 143 >>>             token = request.args.get('token')
 144 >>>             try:
 145 >>>                 token_data = jwt_decod(token)
 146 >>>                 app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist data: <%s>', token, token_data)
 147 >>>             except:
 148 >>>                 p = 0
 149 >>>                 token_data = ""
 150 >>>                 flash('Token incorrect')
 151 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect', token)
 152 >>>             if token_data:
 153 >>>                 uid = token_data["id"]
 154 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()
 155 >>>                 if user:
 156 >>>                     p = 1
 157 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist user: <%s>', token, user.login)
 158 >>>                     return render_template("recpass.html", p=p, token=token)
 159 >>>                 else:
 160 >>>                     p = 0
 161 >>>                     flash('Token incorrect')
 162 >>>                     app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist user.', token)
 163 >>>             else:
 164 >>>                 p = 0
 165 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)
 166 >>>                 flash('Token incorrect')
 167 >>>         if request.args.get('token') and request.args.get('password'):
 168 >>>             token = request.args.get('token')
 169 >>>             try:
 170 >>>                 token_data = jwt_decod(token)
 171 >>>             except:
 172 >>>                 p = 0
 173 >>>                 token_data = ""
 174 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data. Password: <%s>', token, request.args.get('password'))
 175 >>>                 flash('Token incorrect')
 176 >>>             if token_data:
 177 >>>                 uid = token_data["id"]
 178 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()
 179 >>>                 if user:
 180 >>>                     p = 0
 181 >>>                     user.password = generate_password_hash(request.args.get('password'))
 182 >>>                     user.token = ""
 183 >>>                     try:
 184 >>>                         db.session.add(user)
 185 >>>                         db.session.commit()
 186 >>>                         app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> change password', user.login)
 187 >>>                     except:
 188 >>>                         app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', user.login)
 189 >>>                         flash('Error DB insert')
 190 >>>             else:
 191 >>>                 p = 0
 192 >>>                 flash('Token incorrect')
 193 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)
 194 >>>     else:
 195 >>>         pass
 196 >>>     return render_template("recpass.html", p=p, token=token)
 197     
 198     
 199     @app.after_request
```

**Suggested Fix:** Использовать криптографически стойкие одноразовые токены с истечением, связывать их с устройством/почтой, вводить rate‑limit и обязательную повторную аутентификацию.

**Proof of Concept:** Инициировать восстановление и перебрать/предсказать код/токен подтверждения из ограниченного пространства (см. routes.py:120-196; func.py:37). Отсутствие rate‑limit/подтверждения e‑mail упрощает атаку.

---

### 7. Слабый механизм восстановления пароля

**File:** `/taskstate/tsapp/func.py`
**Location:** Lines 37-37
**CWE:** CWE-640 Weak Password Recovery Mechanism for Forgotten Password
**Risk:** HIGH – позволяет перехватить/сбросить пароль жертвы через предсказуемый/несекурный токен или без достаточной верификации.

**Vulnerable Code:**
```python
  34     
  35     def jwt_encod(user):
  36         jwt_data = {"id": user.id,"login": user.login}
  37 >>>     token = jwt.encode(jwt_data, JWT_KEY, algorithm="HS256")
  38         return token
  39     
  40     
```

**Suggested Fix:** Использовать криптографически стойкие одноразовые токены с истечением, связывать их с устройством/почтой, вводить rate‑limit и обязательную повторную аутентификацию.

**Proof of Concept:** Инициировать восстановление и перебрать/предсказать код/токен подтверждения из ограниченного пространства (см. routes.py:120-196; func.py:37). Отсутствие rate‑limit/подтверждения e‑mail упрощает атаку.

---

### 8. Server-Side Template Injection (SSTI)

**File:** `/taskstate/tsapp/routes.py`
**Location:** Lines 405-405
**CWE:** CWE-1336 Improper Neutralization of Special Elements Used in a Template Engine
**Risk:** HIGH – SSTI часто эскалирует до RCE через доступ к объектам/OS.

**Vulnerable Code:**
```python
 402             if rid == 0:
 403                 tasks = TS_Task.query.filter(and_(TS_Task.uid1==current_user.id, TS_Task.title.contains(tsearch))).order_by(TS_Task.date.desc()).all()
 404             app.logger.info('[FUNC] [/search] [Succeess] User:<%s> Role:<%d> Data:<%s>',current_user.login, rid, tsearch)
 405 >>>         return render_template("searchlist.html", tasks=tasks, tstatus=tstatus, tsearch=render_template_string(tsearch))
 406         else:
 407             return redirect(url_for('index'))
 408     
```

**Suggested Fix:** Никогда не передавать непроверенный ввод в render_template_string; экранировать данные, включить sandbox/jinja2.StrictUndefined и использовать белые списки полей.

**Proof of Concept:** Передать {{7*7}} в поле/параметр, который шаблон отрисовывает напрямую (см. routes.py:405). В ответе появится 49; далее возможна эскалация к RCE.

---

## MEDIUM Severity (2 issues)

### 1. Хардкоды секретов и паролей в коде

**File:** `/taskstate/tsapp/sconfig.py`
**Location:** Lines 3-4
**CWE:** CWE-798/259 Use of Hard-coded Credentials/Passwords
**Risk:** MEDIUM – утечка ключей/паролей ведёт к несанкционированному доступу; в проде риск фактически HIGH.

**Vulnerable Code:**
```python
   1     import os
   2     
   3 >>> SECRET_KEY = 'CTF-2#SecretKey'
   4 >>> JWT_KEY = 'CTF-2#PirateLabel'
   5     desteam = ["External order", "Internal order", "Technical order"]
   6     tstatus = ["ToDo","Doing", "Done"]
   7     rteam = ["Sailor", "Corsair", "Captain"]
```

**Suggested Fix:** Удалить секреты из кода; хранить в переменных окружения/secret manager, внедрить ротацию и детектирование утечек в CI.

**Proof of Concept:** Найти значения в коде (routes.py:102,123,149,173,182,486; sconfig.py:3-4) и использовать для аутентификации/подключения к сервисам.

---

### 2. Хардкоды секретов и паролей в коде

**File:** `/taskstate/tsapp/routes.py`
**Location:** Lines 102-102
**CWE:** CWE-798/259 Use of Hard-coded Credentials/Passwords
**Risk:** MEDIUM – утечка ключей/паролей ведёт к несанкционированному доступу; в проде риск фактически HIGH.

**Vulnerable Code:**
```python
  99                 flash('Please, fill fileds: login, password')
 100                 return redirect('/reg')
 101             elif not(TS_User.query.filter_by(login=ulogin).first()) and ulogin and upassword:
 102 >>>             user = TS_User(login=ulogin, password=generate_password_hash(upassword), email=request.form['email'], rid=0, token="")
 103                 try:
 104                     db.session.add(user)
 105                     db.session.commit()
```

**Suggested Fix:** Удалить секреты из кода; хранить в переменных окружения/secret manager, внедрить ротацию и детектирование утечек в CI.

**Proof of Concept:** Найти значения в коде (routes.py:102,123,149,173,182,486; sconfig.py:3-4) и использовать для аутентификации/подключения к сервисам.

---

