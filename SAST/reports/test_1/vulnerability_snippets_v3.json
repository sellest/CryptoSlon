{
  "metadata": {
    "source_report": "/Users/izelikson/python/CryptoSlon/SAST/reports/first_test/triage_analysis_v5.json",
    "code_base_path": "/Users/izelikson/python/CryptoSlon/SAST/code_for_sast/taskstate_copy/",
    "generated_at": "2025-08-24T00:00:00Z",
    "total_snippets": 10
  },
  "vulnerabilities": [
    {
      "vulnerability": "Неправильное управление привилегиями в маршрутах",
      "file": "/taskstate/tsapp/routes.py",
      "location": "416-429",
      "original": " 413         reg = 0\n 414         rid = f_rid_get(request)\n 415         page = request.args.get(get_page_parameter(), type=int, default=1)\n 416 >>>     if rid == 2:\n 417 >>>         users = TS_User.query.order_by(TS_User.id.desc()).paginate(page=page, per_page=10)\n 418 >>>         pagination = Pagination(page=page, total=users.total, record_name='users')\n 419 >>>         app.logger.info('[FUNC] [/adminpanel] [Succeess] User:<%s> Role:<%d>/<%d> Read users: <%d>', current_user.login, current_user.rid, rid, len(users.items))\n 420 >>>         return render_template(\"admpanel.html\", users=users, rteam=rteam, reg=reg, pagination=pagination)\n 421 >>>     else:\n 422 >>>         users = TS_User.query.filter(TS_User.rid==2).order_by(TS_User.id.desc()).all()\n 423 >>>         if len(users) == 0:\n 424 >>>             reg = 1\n 425 >>>             app.logger.info('[FUNC] [/adminpanel] [Succeess] User:<%s> Role:<%d>/<%d> Start initialization >> Registration of a new captain for the service', current_user.login, current_user.rid, rid)\n 426 >>>             return render_template(\"admpanel.html\", users=users, rteam=rteam, reg=reg)\n 427 >>>         else:\n 428 >>>             app.logger.warning('[FUNC] [/adminpanel] [Failed] User:<%s> Access is denied', current_user.login)\n 429 >>>             return redirect(url_for('index'))\n 430     \n 431     \n 432     @app.route('/adm/<int:id>/nrteam')",
      "suggested_fix": "Явно внедрить декораторы @login_required/@roles_required и централизованные проверки ACL перед любыми чувствительными действиями; добавить unit/integ‑тесты на отказ без привилегий.",
      "poc": "Обратиться к одному из эндпоинтов с админ‑функцией без токена/сессии (см. routes.py:416-451) и получить 200/успешный результат; либо вручную изменить роль/идентификатор в запросе/сессии и вызвать операции изменения ролей (routes.py:458-473).",
      "risk": "HIGH – множество (21) мест без корректных проверок доступа позволяет горизонтальную/вертикальную эскалацию привилегий.",
      "severity": "HIGH",
      "cwe": "CWE-269 Improper Privilege Management",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Неправильное управление привилегиями в маршрутах",
      "file": "/taskstate/tsapp/routes.py",
      "location": "436-451",
      "original": " 433     @login_required\n 434     def adm_nrteam(id):\n 435         rid = f_rid_get(request)\n 436 >>>     if rid == 2:\n 437 >>>         user = TS_User.query.filter(TS_User.id==id).order_by(TS_User.date.desc()).first()\n 438 >>>         if user:\n 439 >>>             if user.rid != 2:\n 440 >>>                 user.rid += 1\n 441 >>>                 try:\n 442 >>>                     db.session.commit()\n 443 >>>                     app.logger.info('[FUNC] [/adminpanel/nrteam] [Succeess] User:<%s> Role:<%d>/<%d> For user:<%s> upd role to:<%d>', current_user.login, current_user.rid, rid, user.login, user.rid)\n 444 >>>                 except:\n 445 >>>                     app.logger.error('[FUNC] [/adminpanel/nrteam] [Succeess] User:<%s> Role:<%d> For user:<%s> upd role to:<%d>. Error DB delete!', current_user.login, current_user.rid, user.login, user.rid)\n 446 >>>                     return \"Error DB delete!\"\n 447 >>>         else:\n 448 >>>             app.logger.warning('[FUNC] [/adminpanel/nrteam] [Failed] User:<%s> Role:<%d> For user:<%s> upd role to:<%d> User not found!', current_user.login, current_user.rid, user.login, user.rid)\n 449 >>>         return redirect(url_for('adm'))\n 450 >>>     else:\n 451 >>>         redirect(url_for('index'))\n 452     \n 453     \n 454     @app.route('/adm/<int:id>/brteam')",
      "suggested_fix": "Явно внедрить декораторы @login_required/@roles_required и централизованные проверки ACL перед любыми чувствительными действиями; добавить unit/integ‑тесты на отказ без привилегий.",
      "poc": "Обратиться к одному из эндпоинтов с админ‑функцией без токена/сессии (см. routes.py:416-451) и получить 200/успешный результат; либо вручную изменить роль/идентификатор в запросе/сессии и вызвать операции изменения ролей (routes.py:458-473).",
      "risk": "HIGH – множество (21) мест без корректных проверок доступа позволяет горизонтальную/вертикальную эскалацию привилегий.",
      "severity": "HIGH",
      "cwe": "CWE-269 Improper Privilege Management",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Неправильное управление привилегиями в маршрутах",
      "file": "/taskstate/app.py",
      "location": "14-17",
      "original": "  11             app.logger.info('[INIT] [DB] [Succeess] DB create <%s>', app.config['SQLALCHEMY_DATABASE_URI'])\n  12             time.sleep(3)\n  13     \n  14 >>> if __name__ == '__main__':\n  15 >>>     with app.app_context():\n  16 >>>         db.create_all()\n  17 >>>         app.run()",
      "suggested_fix": "Явно внедрить декораторы @login_required/@roles_required и централизованные проверки ACL перед любыми чувствительными действиями; добавить unit/integ‑тесты на отказ без привилегий.",
      "poc": "Обратиться к одному из эндпоинтов с админ‑функцией без токена/сессии (см. routes.py:416-451) и получить 200/успешный результат; либо вручную изменить роль/идентификатор в запросе/сессии и вызвать операции изменения ролей (routes.py:458-473).",
      "risk": "HIGH – множество (21) мест без корректных проверок доступа позволяет горизонтальную/вертикальную эскалацию привилегий.",
      "severity": "HIGH",
      "cwe": "CWE-269 Improper Privilege Management",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Code Injection через eval/exec",
      "file": "/taskstate/tsapp/routes.py",
      "location": "217-218",
      "original": " 214     @login_required\n 215     def taskcreate():\n 216         if request.method == \"POST\":\n 217 >>>         if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):\n 218 >>>             task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=eval(request.form['private']), uid1=current_user.id, uid2=-1)\n 219                 try:\n 220                     db.session.add(task)\n 221                     db.session.commit()",
      "suggested_fix": "Убрать eval/exec; заменить на безопасные парсеры/вайтлисты, использовать явное сопоставление операций и типов данных.",
      "poc": "Передать в параметр, который попадает в eval/exec, значение: __import__('os').system('id') и получить выполнение команды (см. routes.py:217,218,258,262).",
      "risk": "HIGH – выполнение произвольного кода через eval/exec ведёт к RCE и полному захвату сервера.",
      "severity": "HIGH",
      "cwe": "CWE-95 Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')",
      "sources": [
        "both"
      ]
    },
    {
      "vulnerability": "Code Injection через eval/exec",
      "file": "/taskstate/tsapp/routes.py",
      "location": "258-262",
      "original": " 255         task = TS_Task.query.filter(and_(TS_Task.uid1==current_user.id, TS_Task.tid==tid)).order_by(TS_Task.date.desc()).first()\n 256         if task:\n 257             if request.method == \"POST\":\n 258 >>>             if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):\n 259 >>>                 task.title = request.form['title']\n 260 >>>                 task.description = request.form['description']\n 261 >>>                 task.did = int(request.form['did'])\n 262 >>>                 task.private = eval(request.form['private'])\n 263                     try:\n 264                         db.session.commit()\n 265                         app.logger.info('[FUNC] [/task/edit] [Succeess] User:<%s> Edit task: <%s> owner:<%s>', current_user.login, task.tid, task.TS_User.login)",
      "suggested_fix": "Убрать eval/exec; заменить на безопасные парсеры/вайтлисты, использовать явное сопоставление операций и типов данных.",
      "poc": "Передать в параметр, который попадает в eval/exec, значение: __import__('os').system('id') и получить выполнение команды (см. routes.py:217,218,258,262).",
      "risk": "HIGH – выполнение произвольного кода через eval/exec ведёт к RCE и полному захвату сервера.",
      "severity": "HIGH",
      "cwe": "CWE-95 Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')",
      "sources": [
        "both"
      ]
    },
    {
      "vulnerability": "Слабый механизм восстановления пароля",
      "file": "/taskstate/tsapp/routes.py",
      "location": "120-196",
      "original": " 117             return render_template(\"reg.html\")\n 118     \n 119     \n 120 >>> @app.route('/passrec', methods=['POST','GET'])\n 121 >>> def passrec():\n 122 >>>     p = 0\n 123 >>>     token = \"\"\n 124 >>>     if len(request.args) > 0:\n 125 >>>         if request.args.get('login'):\n 126 >>>             ulogin = request.args.get('login')\n 127 >>>             user = TS_User.query.filter(TS_User.login==ulogin).first()\n 128 >>>             if user:\n 129 >>>                 token = jwt_encod(user)\n 130 >>>                 user.token = token\n 131 >>>                 try:\n 132 >>>                     db.session.add(user)\n 133 >>>                     db.session.commit()\n 134 >>>                     flash('Token created...')\n 135 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> token <%s> created', ulogin, token)\n 136 >>>                 except:\n 137 >>>                     app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', ulogin)\n 138 >>>                     flash('Error DB insert')\n 139 >>>             else:\n 140 >>>                 flash('Login incorrect')\n 141 >>>                 app.logger.warning('[AUTH] [passrec] [Failed] User:<%s> does not exist', ulogin)\n 142 >>>         if request.args.get('token') and not request.args.get('password'):\n 143 >>>             token = request.args.get('token')\n 144 >>>             try:\n 145 >>>                 token_data = jwt_decod(token)\n 146 >>>                 app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist data: <%s>', token, token_data)\n 147 >>>             except:\n 148 >>>                 p = 0\n 149 >>>                 token_data = \"\"\n 150 >>>                 flash('Token incorrect')\n 151 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect', token)\n 152 >>>             if token_data:\n 153 >>>                 uid = token_data[\"id\"]\n 154 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()\n 155 >>>                 if user:\n 156 >>>                     p = 1\n 157 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist user: <%s>', token, user.login)\n 158 >>>                     return render_template(\"recpass.html\", p=p, token=token)\n 159 >>>                 else:\n 160 >>>                     p = 0\n 161 >>>                     flash('Token incorrect')\n 162 >>>                     app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist user.', token)\n 163 >>>             else:\n 164 >>>                 p = 0\n 165 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)\n 166 >>>                 flash('Token incorrect')\n 167 >>>         if request.args.get('token') and request.args.get('password'):\n 168 >>>             token = request.args.get('token')\n 169 >>>             try:\n 170 >>>                 token_data = jwt_decod(token)\n 171 >>>             except:\n 172 >>>                 p = 0\n 173 >>>                 token_data = \"\"\n 174 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data. Password: <%s>', token, request.args.get('password'))\n 175 >>>                 flash('Token incorrect')\n 176 >>>             if token_data:\n 177 >>>                 uid = token_data[\"id\"]\n 178 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()\n 179 >>>                 if user:\n 180 >>>                     p = 0\n 181 >>>                     user.password = generate_password_hash(request.args.get('password'))\n 182 >>>                     user.token = \"\"\n 183 >>>                     try:\n 184 >>>                         db.session.add(user)\n 185 >>>                         db.session.commit()\n 186 >>>                         app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> change password', user.login)\n 187 >>>                     except:\n 188 >>>                         app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', user.login)\n 189 >>>                         flash('Error DB insert')\n 190 >>>             else:\n 191 >>>                 p = 0\n 192 >>>                 flash('Token incorrect')\n 193 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)\n 194 >>>     else:\n 195 >>>         pass\n 196 >>>     return render_template(\"recpass.html\", p=p, token=token)\n 197     \n 198     \n 199     @app.after_request",
      "suggested_fix": "Использовать криптографически стойкие одноразовые токены с истечением, связывать их с устройством/почтой, вводить rate‑limit и обязательную повторную аутентификацию.",
      "poc": "Инициировать восстановление и перебрать/предсказать код/токен подтверждения из ограниченного пространства (см. routes.py:120-196; func.py:37). Отсутствие rate‑limit/подтверждения e‑mail упрощает атаку.",
      "risk": "HIGH – позволяет перехватить/сбросить пароль жертвы через предсказуемый/несекурный токен или без достаточной верификации.",
      "severity": "HIGH",
      "cwe": "CWE-640 Weak Password Recovery Mechanism for Forgotten Password",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Слабый механизм восстановления пароля",
      "file": "/taskstate/tsapp/func.py",
      "location": "37-37",
      "original": "  34     \n  35     def jwt_encod(user):\n  36         jwt_data = {\"id\": user.id,\"login\": user.login}\n  37 >>>     token = jwt.encode(jwt_data, JWT_KEY, algorithm=\"HS256\")\n  38         return token\n  39     \n  40     ",
      "suggested_fix": "Использовать криптографически стойкие одноразовые токены с истечением, связывать их с устройством/почтой, вводить rate‑limit и обязательную повторную аутентификацию.",
      "poc": "Инициировать восстановление и перебрать/предсказать код/токен подтверждения из ограниченного пространства (см. routes.py:120-196; func.py:37). Отсутствие rate‑limit/подтверждения e‑mail упрощает атаку.",
      "risk": "HIGH – позволяет перехватить/сбросить пароль жертвы через предсказуемый/несекурный токен или без достаточной верификации.",
      "severity": "HIGH",
      "cwe": "CWE-640 Weak Password Recovery Mechanism for Forgotten Password",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Server-Side Template Injection (SSTI)",
      "file": "/taskstate/tsapp/routes.py",
      "location": "405-405",
      "original": " 402             if rid == 0:\n 403                 tasks = TS_Task.query.filter(and_(TS_Task.uid1==current_user.id, TS_Task.title.contains(tsearch))).order_by(TS_Task.date.desc()).all()\n 404             app.logger.info('[FUNC] [/search] [Succeess] User:<%s> Role:<%d> Data:<%s>',current_user.login, rid, tsearch)\n 405 >>>         return render_template(\"searchlist.html\", tasks=tasks, tstatus=tstatus, tsearch=render_template_string(tsearch))\n 406         else:\n 407             return redirect(url_for('index'))\n 408     ",
      "suggested_fix": "Никогда не передавать непроверенный ввод в render_template_string; экранировать данные, включить sandbox/jinja2.StrictUndefined и использовать белые списки полей.",
      "poc": "Передать {{7*7}} в поле/параметр, который шаблон отрисовывает напрямую (см. routes.py:405). В ответе появится 49; далее возможна эскалация к RCE.",
      "risk": "HIGH – SSTI часто эскалирует до RCE через доступ к объектам/OS.",
      "severity": "HIGH",
      "cwe": "CWE-1336 Improper Neutralization of Special Elements Used in a Template Engine",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Хардкоды секретов и паролей в коде",
      "file": "/taskstate/tsapp/sconfig.py",
      "location": "3-4",
      "original": "   1     import os\n   2     \n   3 >>> SECRET_KEY = 'CTF-2#SecretKey'\n   4 >>> JWT_KEY = 'CTF-2#PirateLabel'\n   5     desteam = [\"External order\", \"Internal order\", \"Technical order\"]\n   6     tstatus = [\"ToDo\",\"Doing\", \"Done\"]\n   7     rteam = [\"Sailor\", \"Corsair\", \"Captain\"]",
      "suggested_fix": "Удалить секреты из кода; хранить в переменных окружения/secret manager, внедрить ротацию и детектирование утечек в CI.",
      "poc": "Найти значения в коде (routes.py:102,123,149,173,182,486; sconfig.py:3-4) и использовать для аутентификации/подключения к сервисам.",
      "risk": "MEDIUM – утечка ключей/паролей ведёт к несанкционированному доступу; в проде риск фактически HIGH.",
      "severity": "MEDIUM",
      "cwe": "CWE-798/259 Use of Hard-coded Credentials/Passwords",
      "sources": [
        "both"
      ]
    },
    {
      "vulnerability": "Хардкоды секретов и паролей в коде",
      "file": "/taskstate/tsapp/routes.py",
      "location": "102-102",
      "original": "  99                 flash('Please, fill fileds: login, password')\n 100                 return redirect('/reg')\n 101             elif not(TS_User.query.filter_by(login=ulogin).first()) and ulogin and upassword:\n 102 >>>             user = TS_User(login=ulogin, password=generate_password_hash(upassword), email=request.form['email'], rid=0, token=\"\")\n 103                 try:\n 104                     db.session.add(user)\n 105                     db.session.commit()",
      "suggested_fix": "Удалить секреты из кода; хранить в переменных окружения/secret manager, внедрить ротацию и детектирование утечек в CI.",
      "poc": "Найти значения в коде (routes.py:102,123,149,173,182,486; sconfig.py:3-4) и использовать для аутентификации/подключения к сервисам.",
      "risk": "MEDIUM – утечка ключей/паролей ведёт к несанкционированному доступу; в проде риск фактически HIGH.",
      "severity": "MEDIUM",
      "cwe": "CWE-798/259 Use of Hard-coded Credentials/Passwords",
      "sources": [
        "both"
      ]
    }
  ]
}