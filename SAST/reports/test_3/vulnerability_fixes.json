{
  "metadata": {
    "source_report": "/Users/izelikson/python/CryptoSlon/SAST/reports/test_3/vulnerability_snippets.json",
    "model": "gpt-5-mini",
    "template": "vulnerability_fix_v2",
    "generated_at": "2025-08-24T00:00:00Z",
    "total_fixes": 3
  },
  "fixes": [
    {
      "vulnerability_info": {
        "type": "Improper Privilege Management в маршрутах приложения",
        "cwe": "CWE-269 Improper Privilege Management",
        "file": "/taskstate_test/tsapp/routes.py",
        "location": "216-232",
        "severity": "HIGH"
      },
      "original_code": " 211     \n 212     \n 213     @app.route('/taskcreate', methods=['POST'])\n 214     @login_required\n 215     def taskcreate():\n 216 >>>     if request.method == \"POST\":\n 217 >>>         if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):\n 218 >>>             task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=eval(request.form['private']), uid1=current_user.id, uid2=-1)\n 219 >>>             try:\n 220 >>>                 db.session.add(task)\n 221 >>>                 db.session.commit()\n 222 >>>                 app.logger.info('[FUNC] [/taskcreate] [Succeess] User:<%s> Title:<%s> Description:<%s>',current_user.login, task.title, task.description)\n 223 >>>                 return redirect(url_for('mytask'))\n 224 >>>             except:\n 225 >>>                 app.logger.error('[FUNC] [/taskcreate] [Failed] User:<%s> Error DB insert',current_user.login)\n 226 >>>                 flash('Error DB insert')\n 227 >>>                 return redirect(url_for('mytask'))\n 228 >>>         else:\n 229 >>>             flash('Please, enter all rewuired data!')\n 230 >>>             return redirect(url_for('mytask'))\n 231 >>>     else:\n 232 >>>         return redirect(url_for('mytask'))\n 233     \n 234     \n 235     @app.route('/task/<int:tid>')\n 236     @login_required\n 237     def task_detail(tid):",
      "suggested_fix": "Ввести централизованный RBAC/ABAC-мидлвар, обязательные декораторы @login_required/@roles_required на всех чувствительных эндпоинтах.",
      "llm_response": "@app.route('/taskcreate', methods=['POST'])\n@login_required\ndef taskcreate():\n    allowed_roles = {'admin', 'manager', 'creator'}\n    user_role = getattr(current_user, 'role', None)\n    if user_role is not None and user_role not in allowed_roles:\n        flash('Insufficient privileges to create tasks.')\n        return redirect(url_for('mytask'))\n    if request.method == \"POST\":\n        if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):\n            task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=eval(request.form['private']), uid1=current_user.id, uid2=-1)\n            try:\n                db.session.add(task)\n                db.session.commit()\n                app.logger.info('[FUNC] [/taskcreate] [Succeess] User:<%s> Title:<%s> Description:<%s>',current_user.login, task.title, task.description)\n                return redirect(url_for('mytask'))\n            except:\n                app.logger.error('[FUNC] [/taskcreate] [Failed] User:<%s> Error DB insert',current_user.login)\n                flash('Error DB insert')\n                return redirect(url_for('mytask'))\n        else:\n            flash('Please, enter all rewuired data!')\n            return redirect(url_for('mytask'))\n    else:\n        return redirect(url_for('mytask'))",
      "model_used": "gpt-5-mini"
    },
    {
      "vulnerability_info": {
        "type": "Code Injection через динамическое выполнение кода",
        "cwe": "CWE-95 Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')",
        "file": "/taskstate_test/tsapp/routes.py",
        "location": "217-218",
        "severity": "HIGH"
      },
      "original_code": " 212     \n 213     @app.route('/taskcreate', methods=['POST'])\n 214     @login_required\n 215     def taskcreate():\n 216         if request.method == \"POST\":\n 217 >>>         if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):\n 218 >>>             task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=eval(request.form['private']), uid1=current_user.id, uid2=-1)\n 219                 try:\n 220                     db.session.add(task)\n 221                     db.session.commit()\n 222                     app.logger.info('[FUNC] [/taskcreate] [Succeess] User:<%s> Title:<%s> Description:<%s>',current_user.login, task.title, task.description)\n 223                     return redirect(url_for('mytask'))",
      "suggested_fix": "Убрать eval/exec; реализовать белый список операций/интерпретацию через безопасные парсеры; валидировать/экранировать вход.",
      "llm_response": "        if request.method == \"POST\":\n            private_raw = request.form.get('private', 'false')\n            if (len(request.form['title']) > 2 and request.form.get('did', '').lstrip('-').isdigit() and private_raw.lower() in ('true','false')):\n                private_val = True if private_raw.lower() == 'true' else False\n                task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=private_val, uid1=current_user.id, uid2=-1)",
      "model_used": "gpt-5-mini"
    },
    {
      "vulnerability_info": {
        "type": "Слабый механизм восстановления пароля",
        "cwe": "CWE-640 Weak Password Recovery Mechanism for Forgotten Password",
        "file": "/taskstate_test/tsapp/routes.py",
        "location": "120-196",
        "severity": "HIGH"
      },
      "original_code": " 115                 return redirect('/reg')\n 116         else:\n 117             return render_template(\"reg.html\")\n 118     \n 119     \n 120 >>> @app.route('/passrec', methods=['POST','GET'])\n 121 >>> def passrec():\n 122 >>>     p = 0\n 123 >>>     token = \"\"\n 124 >>>     if len(request.args) > 0:\n 125 >>>         if request.args.get('login'):\n 126 >>>             ulogin = request.args.get('login')\n 127 >>>             user = TS_User.query.filter(TS_User.login==ulogin).first()\n 128 >>>             if user:\n 129 >>>                 token = jwt_encod(user)\n 130 >>>                 user.token = token\n 131 >>>                 try:\n 132 >>>                     db.session.add(user)\n 133 >>>                     db.session.commit()\n 134 >>>                     flash('Token created...')\n 135 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> token <%s> created', ulogin, token)\n 136 >>>                 except:\n 137 >>>                     app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', ulogin)\n 138 >>>                     flash('Error DB insert')\n 139 >>>             else:\n 140 >>>                 flash('Login incorrect')\n 141 >>>                 app.logger.warning('[AUTH] [passrec] [Failed] User:<%s> does not exist', ulogin)\n 142 >>>         if request.args.get('token') and not request.args.get('password'):\n 143 >>>             token = request.args.get('token')\n 144 >>>             try:\n 145 >>>                 token_data = jwt_decod(token)\n 146 >>>                 app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist data: <%s>', token, token_data)\n 147 >>>             except:\n 148 >>>                 p = 0\n 149 >>>                 token_data = \"\"\n 150 >>>                 flash('Token incorrect')\n 151 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect', token)\n 152 >>>             if token_data:\n 153 >>>                 uid = token_data[\"id\"]\n 154 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()\n 155 >>>                 if user:\n 156 >>>                     p = 1\n 157 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist user: <%s>', token, user.login)\n 158 >>>                     return render_template(\"recpass.html\", p=p, token=token)\n 159 >>>                 else:\n 160 >>>                     p = 0\n 161 >>>                     flash('Token incorrect')\n 162 >>>                     app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist user.', token)\n 163 >>>             else:\n 164 >>>                 p = 0\n 165 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)\n 166 >>>                 flash('Token incorrect')\n 167 >>>         if request.args.get('token') and request.args.get('password'):\n 168 >>>             token = request.args.get('token')\n 169 >>>             try:\n 170 >>>                 token_data = jwt_decod(token)\n 171 >>>             except:\n 172 >>>                 p = 0\n 173 >>>                 token_data = \"\"\n 174 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data. Password: <%s>', token, request.args.get('password'))\n 175 >>>                 flash('Token incorrect')\n 176 >>>             if token_data:\n 177 >>>                 uid = token_data[\"id\"]\n 178 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()\n 179 >>>                 if user:\n 180 >>>                     p = 0\n 181 >>>                     user.password = generate_password_hash(request.args.get('password'))\n 182 >>>                     user.token = \"\"\n 183 >>>                     try:\n 184 >>>                         db.session.add(user)\n 185 >>>                         db.session.commit()\n 186 >>>                         app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> change password', user.login)\n 187 >>>                     except:\n 188 >>>                         app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', user.login)\n 189 >>>                         flash('Error DB insert')\n 190 >>>             else:\n 191 >>>                 p = 0\n 192 >>>                 flash('Token incorrect')\n 193 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)\n 194 >>>     else:\n 195 >>>         pass\n 196 >>>     return render_template(\"recpass.html\", p=p, token=token)\n 197     \n 198     \n 199     @app.after_request\n 200     def redirect_to_login(response):\n 201         if response.status_code == 401:",
      "suggested_fix": "Использовать криптографически стойкие одноразовые токены с истечением, привязкой к пользователю и проверкой; применять проверенные фреймворк-утилиты.",
      "llm_response": "        if request.method == 'POST' and request.form.get('token') and request.form.get('password'):\n            token = request.form.get('token')\n            try:\n                token_data = jwt_decod(token)\n            except:\n                p = 0\n                token_data = \"\"\n                app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data. Password: <REDACTED>', token)\n                flash('Token incorrect')\n            if token_data:\n                uid = token_data[\"id\"]\n                user = TS_User.query.filter(TS_User.id==uid).first()\n                if user:\n                    p = 0\n                    user.password = generate_password_hash(request.form.get('password'))\n                    user.token = \"\"\n                    try:\n                        db.session.add(user)\n                        db.session.commit()\n                        app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> change password', user.login)\n                    except:\n                        app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', user.login)\n                        flash('Error DB insert')\n            else:\n                p = 0\n                flash('Token incorrect')\n                app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)",
      "model_used": "gpt-5-mini"
    }
  ]
}