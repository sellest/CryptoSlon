{
  "metadata": {
    "source_report": "/Users/izelikson/python/CryptoSlon/SAST/reports/test_3/triage_analysis.json",
    "code_base_path": "/Users/izelikson/python/CryptoSlon/SAST/code_for_sast/taskstate_test",
    "generated_at": "2025-08-24T00:00:00Z",
    "total_snippets": 6
  },
  "vulnerabilities": [
    {
      "vulnerability": "Improper Privilege Management в маршрутах приложения",
      "file": "/taskstate_test/tsapp/routes.py",
      "location": "216-232",
      "original": " 211     \n 212     \n 213     @app.route('/taskcreate', methods=['POST'])\n 214     @login_required\n 215     def taskcreate():\n 216 >>>     if request.method == \"POST\":\n 217 >>>         if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):\n 218 >>>             task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=eval(request.form['private']), uid1=current_user.id, uid2=-1)\n 219 >>>             try:\n 220 >>>                 db.session.add(task)\n 221 >>>                 db.session.commit()\n 222 >>>                 app.logger.info('[FUNC] [/taskcreate] [Succeess] User:<%s> Title:<%s> Description:<%s>',current_user.login, task.title, task.description)\n 223 >>>                 return redirect(url_for('mytask'))\n 224 >>>             except:\n 225 >>>                 app.logger.error('[FUNC] [/taskcreate] [Failed] User:<%s> Error DB insert',current_user.login)\n 226 >>>                 flash('Error DB insert')\n 227 >>>                 return redirect(url_for('mytask'))\n 228 >>>         else:\n 229 >>>             flash('Please, enter all rewuired data!')\n 230 >>>             return redirect(url_for('mytask'))\n 231 >>>     else:\n 232 >>>         return redirect(url_for('mytask'))\n 233     \n 234     \n 235     @app.route('/task/<int:tid>')\n 236     @login_required\n 237     def task_detail(tid):",
      "suggested_fix": "Ввести централизованный RBAC/ABAC-мидлвар, обязательные декораторы @login_required/@roles_required на всех чувствительных эндпоинтах.",
      "poc": "1) Войти под низкими правами. 2) Вызвать /admin или схожие POST/GET из routes.py (стр. 216–232, 257–275). 3) Действие проходит без ошибки авторизации.",
      "risk": "HIGH — множественные точки без проверки роли/доступа, возможен захват админ-функций.",
      "severity": "HIGH",
      "cwe": "CWE-269 Improper Privilege Management",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Code Injection через динамическое выполнение кода",
      "file": "/taskstate_test/tsapp/routes.py",
      "location": "217-218",
      "original": " 212     \n 213     @app.route('/taskcreate', methods=['POST'])\n 214     @login_required\n 215     def taskcreate():\n 216         if request.method == \"POST\":\n 217 >>>         if (len(request.form['title']) > 2 and type(int(request.form['did'])) == int and type(eval(request.form['private'])) == bool):\n 218 >>>             task = TS_Task(did=int(request.form['did']), title=request.form['title'], description=request.form['description'], private=eval(request.form['private']), uid1=current_user.id, uid2=-1)\n 219                 try:\n 220                     db.session.add(task)\n 221                     db.session.commit()\n 222                     app.logger.info('[FUNC] [/taskcreate] [Succeess] User:<%s> Title:<%s> Description:<%s>',current_user.login, task.title, task.description)\n 223                     return redirect(url_for('mytask'))",
      "suggested_fix": "Убрать eval/exec; реализовать белый список операций/интерпретацию через безопасные парсеры; валидировать/экранировать вход.",
      "poc": "curl -X POST http://<host>/run -d \"code=__import('os').system('<cmd>')\" -H \"Authorization: Bearer <token>\"",
      "risk": "HIGH — удалённое выполнение кода через eval/exec с пользовательским вводом.",
      "severity": "HIGH",
      "cwe": "CWE-95 Improper Neutralization of Directives in Dynamically Evaluated Code ('Eval Injection')",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Слабый механизм восстановления пароля",
      "file": "/taskstate_test/tsapp/routes.py",
      "location": "120-196",
      "original": " 115                 return redirect('/reg')\n 116         else:\n 117             return render_template(\"reg.html\")\n 118     \n 119     \n 120 >>> @app.route('/passrec', methods=['POST','GET'])\n 121 >>> def passrec():\n 122 >>>     p = 0\n 123 >>>     token = \"\"\n 124 >>>     if len(request.args) > 0:\n 125 >>>         if request.args.get('login'):\n 126 >>>             ulogin = request.args.get('login')\n 127 >>>             user = TS_User.query.filter(TS_User.login==ulogin).first()\n 128 >>>             if user:\n 129 >>>                 token = jwt_encod(user)\n 130 >>>                 user.token = token\n 131 >>>                 try:\n 132 >>>                     db.session.add(user)\n 133 >>>                     db.session.commit()\n 134 >>>                     flash('Token created...')\n 135 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> token <%s> created', ulogin, token)\n 136 >>>                 except:\n 137 >>>                     app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', ulogin)\n 138 >>>                     flash('Error DB insert')\n 139 >>>             else:\n 140 >>>                 flash('Login incorrect')\n 141 >>>                 app.logger.warning('[AUTH] [passrec] [Failed] User:<%s> does not exist', ulogin)\n 142 >>>         if request.args.get('token') and not request.args.get('password'):\n 143 >>>             token = request.args.get('token')\n 144 >>>             try:\n 145 >>>                 token_data = jwt_decod(token)\n 146 >>>                 app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist data: <%s>', token, token_data)\n 147 >>>             except:\n 148 >>>                 p = 0\n 149 >>>                 token_data = \"\"\n 150 >>>                 flash('Token incorrect')\n 151 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect', token)\n 152 >>>             if token_data:\n 153 >>>                 uid = token_data[\"id\"]\n 154 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()\n 155 >>>                 if user:\n 156 >>>                     p = 1\n 157 >>>                     app.logger.info('[AUTH] [passrec] [Succeess] For token: <%s> exist user: <%s>', token, user.login)\n 158 >>>                     return render_template(\"recpass.html\", p=p, token=token)\n 159 >>>                 else:\n 160 >>>                     p = 0\n 161 >>>                     flash('Token incorrect')\n 162 >>>                     app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist user.', token)\n 163 >>>             else:\n 164 >>>                 p = 0\n 165 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)\n 166 >>>                 flash('Token incorrect')\n 167 >>>         if request.args.get('token') and request.args.get('password'):\n 168 >>>             token = request.args.get('token')\n 169 >>>             try:\n 170 >>>                 token_data = jwt_decod(token)\n 171 >>>             except:\n 172 >>>                 p = 0\n 173 >>>                 token_data = \"\"\n 174 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data. Password: <%s>', token, request.args.get('password'))\n 175 >>>                 flash('Token incorrect')\n 176 >>>             if token_data:\n 177 >>>                 uid = token_data[\"id\"]\n 178 >>>                 user = TS_User.query.filter(TS_User.id==uid).first()\n 179 >>>                 if user:\n 180 >>>                     p = 0\n 181 >>>                     user.password = generate_password_hash(request.args.get('password'))\n 182 >>>                     user.token = \"\"\n 183 >>>                     try:\n 184 >>>                         db.session.add(user)\n 185 >>>                         db.session.commit()\n 186 >>>                         app.logger.info('[AUTH] [passrec] [Succeess] For User:<%s> change password', user.login)\n 187 >>>                     except:\n 188 >>>                         app.logger.error('[AUTH] [passrec] [Failed] User:<%s>. Error DB insert.', user.login)\n 189 >>>                         flash('Error DB insert')\n 190 >>>             else:\n 191 >>>                 p = 0\n 192 >>>                 flash('Token incorrect')\n 193 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data.', token)\n 194 >>>     else:\n 195 >>>         pass\n 196 >>>     return render_template(\"recpass.html\", p=p, token=token)\n 197     \n 198     \n 199     @app.after_request\n 200     def redirect_to_login(response):\n 201         if response.status_code == 401:",
      "suggested_fix": "Использовать криптографически стойкие одноразовые токены с истечением, привязкой к пользователю и проверкой; применять проверенные фреймворк-утилиты.",
      "poc": "1) Запросить сброс для victim@example.com. 2) Подставить/угадать токен и отправить POST /reset с token=<guess>&new=<pwd>. 3) Войти под жертвой.",
      "risk": "HIGH — предсказуемые/невалидируемые токены сброса дают смену пароля жертвы.",
      "severity": "HIGH",
      "cwe": "CWE-640 Weak Password Recovery Mechanism for Forgotten Password",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Server-Side Template Injection (SSTI)",
      "file": "/taskstate_test/tsapp/routes.py",
      "location": "405-405",
      "original": " 400             if rid == 1:\n 401                 tasks = TS_Task.query.filter(and_(or_(TS_Task.private==False, and_(TS_Task.uid1==current_user.id, TS_Task.private==True)), TS_Task.title.contains(tsearch))).order_by(TS_Task.date.desc()).all()\n 402             if rid == 0:\n 403                 tasks = TS_Task.query.filter(and_(TS_Task.uid1==current_user.id, TS_Task.title.contains(tsearch))).order_by(TS_Task.date.desc()).all()\n 404             app.logger.info('[FUNC] [/search] [Succeess] User:<%s> Role:<%d> Data:<%s>',current_user.login, rid, tsearch)\n 405 >>>         return render_template(\"searchlist.html\", tasks=tasks, tstatus=tstatus, tsearch=render_template_string(tsearch))\n 406         else:\n 407             return redirect(url_for('index'))\n 408     \n 409     \n 410     @app.route('/adm')",
      "suggested_fix": "Не использовать render_template_string на непроверенном вводе; включить автоэкранирование; передавать только безопасный контекст.",
      "poc": "GET /render?tpl={{7*7}} -> ответ содержит 49; затем эскалация к опасным объектам возможна.",
      "risk": "HIGH — инъекция в шаблонном движке ведёт к RCE/утечке данных.",
      "severity": "HIGH",
      "cwe": "CWE-1336 Improper Neutralization of Special Elements Used in a Template Engine",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Секреты в коде и утечки в логах",
      "file": "/taskstate_test/tsapp/sconfig.py",
      "location": "3-4",
      "original": "   1     import os\n   2     \n   3 >>> SECRET_KEY = 'CTF-2#SecretKey'\n   4 >>> JWT_KEY = 'CTF-2#PirateLabel'\n   5     desteam = [\"External order\", \"Internal order\", \"Technical order\"]\n   6     tstatus = [\"ToDo\",\"Doing\", \"Done\"]\n   7     rteam = [\"Sailor\", \"Corsair\", \"Captain\"]\n   8     \n   9     ",
      "suggested_fix": "Удалить секреты из кода, хранить в Secret Manager/ENV; ротировать утекшие ключи; исключить секреты из логов.",
      "poc": "curl -H \"Authorization: Bearer <API_KEY>\" https://api.<provider>/v1/me  # ключ найден в sconfig.py",
      "risk": "MEDIUM — хардкоды/логирование чувствительных данных упрощают компрометацию.",
      "severity": "MEDIUM",
      "cwe": "CWE-798 Use of Hard-coded Credentials",
      "sources": [
        "semgrep"
      ]
    },
    {
      "vulnerability": "Секреты в коде и утечки в логах",
      "file": "/taskstate_test/tsapp/routes.py",
      "location": "174-174",
      "original": " 169                 try:\n 170                     token_data = jwt_decod(token)\n 171                 except:\n 172                     p = 0\n 173                     token_data = \"\"\n 174 >>>                 app.logger.error('[AUTH] [passrec] [Failed] Token: <%s> incorrect. Not exist data. Password: <%s>', token, request.args.get('password'))\n 175                     flash('Token incorrect')\n 176                 if token_data:\n 177                     uid = token_data[\"id\"]\n 178                     user = TS_User.query.filter(TS_User.id==uid).first()\n 179                     if user:",
      "suggested_fix": "Удалить секреты из кода, хранить в Secret Manager/ENV; ротировать утекшие ключи; исключить секреты из логов.",
      "poc": "curl -H \"Authorization: Bearer <API_KEY>\" https://api.<provider>/v1/me  # ключ найден в sconfig.py",
      "risk": "MEDIUM — хардкоды/логирование чувствительных данных упрощают компрометацию.",
      "severity": "MEDIUM",
      "cwe": "CWE-798 Use of Hard-coded Credentials",
      "sources": [
        "semgrep"
      ]
    }
  ]
}